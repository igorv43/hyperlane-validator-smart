version: '2'
services:
  relayer:
    container_name: hpl-relayer-testnet
    image: gcr.io/abacus-labs-dev/hyperlane-agent:1.7.0
    user: root
    entrypoint: ['sh', '-c']
    environment:
      - RUST_LOG=info,hyperlane=debug,relayer=debug,hyperlane_cosmos=debug
      - HYP_BASE_TRACING_LEVEL=debug
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Database Path - Configure this variable in Easypanel (optional, default: /etc/data/db)
      - HYP_DB=${HYP_DB:-/etc/data/db}
      # Private Keys - Configure these variables in Easypanel
      - HYP_CHAINS_BSCTESTNET_SIGNER_KEY=${HYP_CHAINS_BSCTESTNET_SIGNER_KEY}
      - HYP_CHAINS_SOLANATESTNET_SIGNER_KEY=${HYP_CHAINS_SOLANATESTNET_SIGNER_KEY}
      - HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY=${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker-testnet.json" "/app/config/agent-config.json" && \
        [ ! -f "/etc/hyperlane/relayer.testnet.json" ] && cp "/etc/hyperlane/relayer.testnet.json.example" "/etc/hyperlane/relayer.testnet.json" || true && \
        if [ -n "${HYP_DB}" ]; then \
          sed -i "s|\"db\": \"/etc/data/db\"|\"db\": \"${HYP_DB}\"|g" "/etc/hyperlane/relayer.testnet.json"; \
          echo "Database path replaced: ${HYP_DB}"; \
        fi && \
        CONFIG_FILES="/etc/hyperlane/relayer.testnet.json" \
          ./relayer --allowLocalCheckpointSyncers false --metrics 0.0.0.0:9090 --api 0.0.0.0:9090
    ports:
      - 9112:9090
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./relayer-testnet:/etc/data

  validator-terraclassic:
    container_name: hpl-validator-terraclassic-testnet
    image: gcr.io/abacus-labs-dev/hyperlane-agent:1.7.0
    user: root
    entrypoint: ['sh', '-c']
    environment:
      - RUST_LOG=debug,hyperlane=debug,validator=debug,hyperlane_cosmos=debug
      - HYP_BASE_TRACING_LEVEL=debug
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Database Path - Configure this variable in Easypanel (optional, default: /etc/data/db)
      - HYP_DB=${HYP_DB:-/etc/data/db}
      # S3 Bucket Configuration - Configure these variables in Easypanel
      - HYP_CHECKPOINT_SYNCER_BUCKET=${HYP_CHECKPOINT_SYNCER_BUCKET}
      - HYP_CHECKPOINT_SYNCER_REGION=${HYP_CHECKPOINT_SYNCER_REGION:-${AWS_REGION:-us-east-1}}
      # Private Keys - Configure these variables in Easypanel
      - HYP_VALIDATOR_KEY=${HYP_VALIDATOR_KEY}
      - HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY=${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker-testnet.json" "/app/config/agent-config.json" && \
        echo "Always recreating validator config from example..." && \
        cp "/etc/hyperlane/validator.terraclassic-testnet.json.example" "/etc/hyperlane/validator.terraclassic-testnet.json" && \
        echo "Config file created from example" && \
        echo "Replacing database path..." && \
        if [ -n "${HYP_DB}" ]; then \
          sed -i "s|\"db\": \"/etc/data/db\"|\"db\": \"${HYP_DB}\"|g" "/etc/hyperlane/validator.terraclassic-testnet.json"; \
          echo "Database path replaced: ${HYP_DB}"; \
        fi && \
        echo "Replacing S3 placeholders..." && \
        if [ -n "${HYP_CHECKPOINT_SYNCER_BUCKET}" ]; then \
          sed -i "s|YOUR_S3_BUCKET_NAME|${HYP_CHECKPOINT_SYNCER_BUCKET}|g" "/etc/hyperlane/validator.terraclassic-testnet.json"; \
          echo "S3 bucket replaced: ${HYP_CHECKPOINT_SYNCER_BUCKET}"; \
        else \
          echo "WARNING: HYP_CHECKPOINT_SYNCER_BUCKET not set!"; \
        fi && \
        if [ -n "${HYP_CHECKPOINT_SYNCER_REGION}" ]; then \
          sed -i "s|YOUR_S3_REGION|${HYP_CHECKPOINT_SYNCER_REGION}|g" "/etc/hyperlane/validator.terraclassic-testnet.json"; \
          echo "S3 region replaced: ${HYP_CHECKPOINT_SYNCER_REGION}"; \
        else \
          echo "WARNING: HYP_CHECKPOINT_SYNCER_REGION not set!"; \
        fi && \
        echo "Validating config file..." && \
        if ! grep -q "originChainName" "/etc/hyperlane/validator.terraclassic-testnet.json" || ! grep -q "checkpointSyncer" "/etc/hyperlane/validator.terraclassic-testnet.json"; then \
          echo "ERROR: Config file is still invalid after processing!" && \
          echo "File contents:" && \
          cat "/etc/hyperlane/validator.terraclassic-testnet.json" && \
          exit 1; \
        fi && \
        echo "Config file is valid. Starting validator..." && \
        CONFIG_FILES="/etc/hyperlane/validator.terraclassic-testnet.json" \
          ./validator --metrics 0.0.0.0:9090
    ports:
      - 9122:9090
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./validator-testnet:/etc/data