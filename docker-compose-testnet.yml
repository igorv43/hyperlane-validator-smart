services:
  relayer:
    container_name: hpl-relayer-testnet
    image: gcr.io/abacus-labs-dev/hyperlane-agent:1.7.0
    user: root
    entrypoint: ['sh', '-c']
    environment:
      - RUST_LOG=info,hyperlane=debug,relayer=debug,hyperlane_cosmos=debug
      - HYP_BASE_TRACING_LEVEL=debug
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - HYP_DB=${HYP_DB:-/etc/data/db}
      - HYP_CHAINS_BSCTESTNET_SIGNER_KEY=${HYP_CHAINS_BSCTESTNET_SIGNER_KEY}
      - HYP_CHAINS_SOLANATESTNET_SIGNER_KEY=${HYP_CHAINS_SOLANATESTNET_SIGNER_KEY}
      - HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY=${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}
      - HYP_CHAINS_SEPOLIA_SIGNER_KEY=${HYP_CHAINS_SEPOLIA_SIGNER_KEY}
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker-testnet.json" "/app/config/agent-config.json" && \
        if [ -z "${HYP_CHAINS_BSCTESTNET_SIGNER_KEY}" ] || [ -z "${HYP_CHAINS_SOLANATESTNET_SIGNER_KEY}" ] || [ -z "${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}" ] || [ -z "${HYP_CHAINS_SEPOLIA_SIGNER_KEY}" ]; then \
          echo "ERROR: Signer keys are required!" && \
          exit 1; \
        fi && \
        awk -v bsc="${HYP_CHAINS_BSCTESTNET_SIGNER_KEY}" \
            -v sol="${HYP_CHAINS_SOLANATESTNET_SIGNER_KEY}" \
            -v terra="${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}" \
            -v sep="${HYP_CHAINS_SEPOLIA_SIGNER_KEY}" \
            '{
              if ($0 ~ /"bsctestnet"/) { in_bsc=1; in_sol=0; in_terra=0; in_sep=0 }
              else if ($0 ~ /"solanatestnet"/) { in_bsc=0; in_sol=1; in_terra=0; in_sep=0 }
              else if ($0 ~ /"terraclassictestnet"/) { in_bsc=0; in_sol=0; in_terra=1; in_sep=0 }
              else if ($0 ~ /"sepolia"/) { in_bsc=0; in_sol=0; in_terra=0; in_sep=1 }
              if ($0 ~ /"key": ""/ && in_bsc) { sub(/"key": ""/, "\"key\": \"" bsc "\""); in_bsc=0 }
              else if ($0 ~ /"key": ""/ && in_sol) { sub(/"key": ""/, "\"key\": \"" sol "\""); in_sol=0 }
              else if ($0 ~ /"key": ""/ && in_terra) { sub(/"key": ""/, "\"key\": \"" terra "\""); in_terra=0 }
              else if ($0 ~ /"key": ""/ && in_sep) { sub(/"key": ""/, "\"key\": \"" sep "\""); in_sep=0 }
              print
            }' "/etc/hyperlane/relayer.testnet.json" > "/tmp/relayer.testnet.json" && \
        echo "✅ Relayer config loaded from file and keys injected from .env" && \
        CONFIG_FILES="/tmp/relayer.testnet.json" \
          ./relayer --allowLocalCheckpointSyncers false --metrics 0.0.0.0:9090 --api 0.0.0.0:9090
    ports:
      - "19010:9090"
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./relayer-testnet:/etc/data
    restart: unless-stopped

  validator-terraclassic:
    container_name: hpl-validator-terraclassic-testnet
    image: gcr.io/abacus-labs-dev/hyperlane-agent:1.7.0
    user: root
    entrypoint: ['sh', '-c']
    environment:
      - RUST_LOG=debug,hyperlane=debug,validator=debug,hyperlane_cosmos=debug
      - HYP_BASE_TRACING_LEVEL=debug
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Database Path - Configure this variable in Easypanel (optional, default: /etc/data/db)
      - HYP_DB=${HYP_DB:-/etc/data/db}
      # S3 Bucket Configuration - Configure these variables in Easypanel
      - HYP_CHECKPOINT_SYNCER_BUCKET=${HYP_CHECKPOINT_SYNCER_BUCKET}
      - HYP_CHECKPOINT_SYNCER_REGION=${HYP_CHECKPOINT_SYNCER_REGION}
      # Private Keys - Configure these variables in Easypanel
      - HYP_VALIDATOR_KEY=${HYP_VALIDATOR_KEY}
      - HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY=${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}
    command:
      - |
        rm -rf /app/config/* && \
        cp "/etc/hyperlane/agent-config.docker-testnet.json" "/app/config/agent-config.json" && \
        if [ -z "${HYP_VALIDATOR_KEY}" ] || [ "${HYP_VALIDATOR_KEY}" = "" ]; then \
          echo "ERROR: HYP_VALIDATOR_KEY is required and cannot be empty!" && \
          exit 1; \
        fi && \
        if [ -z "${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}" ] || [ "${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}" = "" ]; then \
          echo "ERROR: HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY is required and cannot be empty!" && \
          exit 1; \
        fi && \
        if [ -z "${HYP_CHECKPOINT_SYNCER_BUCKET}" ] || [ "${HYP_CHECKPOINT_SYNCER_BUCKET}" = "" ]; then \
          echo "ERROR: HYP_CHECKPOINT_SYNCER_BUCKET is required and cannot be empty!" && \
          exit 1; \
        fi && \
        DB_PATH="${HYP_DB:-/etc/data/db}" && \
        BUCKET="${HYP_CHECKPOINT_SYNCER_BUCKET}" && \
        if [ -z "${HYP_CHECKPOINT_SYNCER_REGION}" ]; then \
          REGION_VAL="${AWS_REGION:-us-east-1}"; \
        else \
          REGION_VAL="${HYP_CHECKPOINT_SYNCER_REGION}"; \
        fi && \
        if [ -z "$$REGION_VAL" ]; then \
          REGION_VAL="us-east-1"; \
        fi && \
        VALIDATOR_KEY="${HYP_VALIDATOR_KEY}" && \
        SIGNER_KEY="${HYP_CHAINS_TERRACLASSICTESTNET_SIGNER_KEY}" && \
        if [ -z "$$BUCKET" ] || [ -z "$$REGION_VAL" ]; then \
          echo "ERROR: BUCKET or REGION_VAL is empty!" && \
          exit 1; \
        fi && \
        printf '{\n  "db": "%s",\n  "checkpointSyncer": {\n    "type": "s3",\n    "bucket": "%s",\n    "region": "%s"\n  },\n  "originChainName": "terraclassictestnet",\n  "validator": {\n    "type": "hexKey",\n    "key": "%s"\n  },\n  "chains": {\n    "terraclassictestnet": {\n      "signer": {\n        "type": "cosmosKey",\n        "key": "%s",\n        "prefix": "terra"\n      }\n    }\n  }\n}' \
          "$$DB_PATH" \
          "$$BUCKET" \
          "$$REGION_VAL" \
          "$$VALIDATOR_KEY" \
          "$$SIGNER_KEY" > "/tmp/validator.terraclassic-testnet.json" && \
        if ! grep -q "originChainName" "/tmp/validator.terraclassic-testnet.json" || ! grep -q "checkpointSyncer" "/tmp/validator.terraclassic-testnet.json"; then \
          echo "ERROR: Config file is invalid!" && \
          cat "/tmp/validator.terraclassic-testnet.json" && \
          exit 1; \
        fi && \
        echo "✅ Validator config generated with keys from .env" && \
        CONFIG_FILES="/tmp/validator.terraclassic-testnet.json" \
          ./validator --metrics 0.0.0.0:9090
    ports:
      - "19020:9090"
    volumes:
      - ./hyperlane:/etc/hyperlane
      - ./validator-testnet:/etc/data
    restart: unless-stopped